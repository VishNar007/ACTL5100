---
title: "Data Cleaning"
author: "Helitha Dharmadasa - z5451805"
date: "2024-02-23"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, tidy=TRUE, dpi=360)
```

```{r, message=FALSE}
library(tidyverse)
library(readxl)
```

```{r read}
rate_df <- read_excel("../Data/Case Study Data/srcsc-2024-lumaria-economic-data.xlsx", skip=10)
```

```{r}
mortality_df <- read_excel("../Data/Case Study Data/srcsc-2024-lumaria-mortality-table.xlsx", skip = 13)

mortality_df <- mortality_df %>% mutate(survival_rate = 1 - `Mortality Rate`,
                                        lx = cumprod(survival_rate) * 100000)

mortality_df

```
```{r}



```


```{r}

```

```{r}
# Misc Notes
# For starting_age 
  # For death_age
    # t = (death_age - starting_age)
    # EPV(BENEFITS) = v^(t+1) * k_P_starting_age * Q_starting_age+t
    # EPV(EXPENSES) = v^(t) * k_P_starting_age

# kpx = Prob alive at age k+x given alive at x
# qxk = Prob dies at age k+x+1 given alive at x+k = 1 - (Prob alive at k+x+1 given alive at x+k)

# ToDo:
# 1. Wrap into function (Inputs: Policy duration, interest rate, life table with lx values. Output: df)
# 2. Verify tpx and q(x+t) and APV values are correct (Use debug matrix, calc manually)
# 3. Sensitivity Analysis (Notes: Interest rates, Inflation, Mortality)
# 4. Adjust for m-thly? Is this worth doing even
```



```{r}
benefit_model <- function(policy_duration, mortality_table, interest_rate, inflation_rate) {

  real_rate = ((interest_rate - inflation_rate)/(1 + inflation_rate))
  
  v = 1 / (1+real_rate)
  
  output_df <- tibble(age = 1:120, 
                      EPV_single= rep(0, 120),
                      EPV_annuity_due = rep(0, 120),
                      EPV_single_18 = rep(0, 120),
                      EPV_annuity_due_18 = rep(0, 120),
                      EPV_annuity_due_50 = rep(0, 120))
  
  #debug_mat  <- matrix(0, nrow = 120, ncol = 120)
  
  # Ages 1-119
  # Note: 119 because we don't have Age 121 in life table for 120 calc.
  for (starting_age in 1:119) {
  
    single = 0
    annuity_due = 0
    single_18 = 0
    annuity_due_18 = 0
    annuity_due_50 = 0
    
    # Rolling window of policy dur or capped at life table limits (truncation error?)
    age_max <- min(starting_age + policy_duration, 119)
    
    for (death_age in starting_age:age_max) {
      
      t = death_age - starting_age
      
      #P(starting age is alive until death age)
      tpx = mortality_table$lx[death_age] / mortality_table$lx[starting_age]
      
      #P(death age dies in the next year)
      qxt = 1 - (mortality_table$lx[death_age+1] / mortality_table$lx[death_age])
  
      #debug
      #debug_mat[starting_age, death_age] = v^(t+1) * tpx * qxt
      
      single = single + v^(t+1) * tpx * qxt     #Paid out EOY of Death
      annuity_due =  annuity_due + v^(t) * tpx          #Paid out SOY of every year alive
      
      if (death_age >= 18) {
        single_18 = single_18 + v^(t+1) * tpx * qxt
        annuity_due_18 = annuity_due_18 + v^(t) * tpx   
      }
      
      if (death_age >= 50) {
        annuity_due_50 = annuity_due_50 + v^(t) * tpx 
      }

      
    }
    
    output_df$EPV_single[starting_age] = single
    output_df$EPV_annuity_due[starting_age] = annuity_due
    output_df$EPV_single_18[starting_age] = single_18
    output_df$EPV_annuity_due_18[starting_age] = annuity_due_18
    output_df$EPV_annuity_due_50[starting_age] = annuity_due_50

  } 
  
  return(output_df)
}
```


```{r}
interest_rate <- mean(rate_df$`1-yr Risk Free Annual Spot Rate`)
inflation_rate <- mean(rate_df$Inflation)

EPV_df <- benefit_model(20, mortality_df, interest_rate, inflation_rate)
```

```{r}
EPV_df
```








